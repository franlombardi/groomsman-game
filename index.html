<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Groomsman Trials</title>
  <!-- Make it work nicely on phones -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg-color: #050816;
      --bg-gradient-top: #050816;
      --bg-gradient-bottom: #151b3b;
      --accent: #ffb347;      /* gold-ish accent */
      --accent-soft: #ffcf7f;
      --text-main: #f5f5f5;
      --text-muted: #b0b3c3;
      --danger: #ff5f5f;
      --good: #4cd964;
      --card-bg: rgba(10, 15, 35, 0.95);
      --card-border: rgba(255, 255, 255, 0.1);
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.6);
      --radius-xl: 24px;
      --radius-lg: 18px;
      --radius-md: 12px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 50%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 12px;
    }

    .app {
      width: 100%;
      max-width: 420px;
      background: linear-gradient(145deg, var(--bg-gradient-top), var(--bg-gradient-bottom));
      border-radius: 32px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: var(--shadow-soft);
      padding: 14px 14px 18px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
      overflow: hidden;
    }

    .app::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top left, rgba(255, 255, 255, 0.06), transparent 60%),
                  radial-gradient(circle at bottom right, rgba(0, 0, 0, 0.6), transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .subtitle {
      font-size: 0.7rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--accent-soft);
    }

    h1 {
      font-size: 1.25rem;
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.68rem;
      color: var(--text-muted);
    }

    .badge span.icon {
      font-size: 0.9rem;
    }

    .hud {
      margin-top: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .hud-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .hud-pill {
      padding: 3px 9px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.92);
      border: 1px solid rgba(148, 163, 184, 0.5);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .hud-pill span.value {
      font-weight: 600;
      color: var(--accent-soft);
    }

    .hud-pill.positive span.value {
      color: var(--good);
    }

    .hud-pill.negative span.value {
      color: var(--danger);
    }

    .hint-text {
      font-size: 0.66rem;
      color: var(--text-muted);
      opacity: 0.9;
    }

    .main {
      flex: 1;
      margin-top: 6px;
      border-radius: 24px;
      background: radial-gradient(circle at top, #111827 0, #020617 55%);
      border: 1px solid rgba(51, 65, 85, 0.8);
      padding: 10px 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .lane-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.65rem;
      color: var(--text-muted);
      padding: 0 2px;
    }

    .canvas-wrapper {
      position: relative;
      border-radius: 20px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: radial-gradient(circle at top, #020617, #020617 60%, #020617);
      flex: 1;
      min-height: 260px;
    }

    canvas {
      width: 100%;
      height: 100%;
      display: block;
      background: transparent;
    }

    .lane-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      pointer-events: none;
    }

    .lane {
      flex: 1;
      border-top: 1px dashed rgba(31, 41, 55, 0.9);
      border-bottom: 1px dashed rgba(31, 41, 55, 0.9);
    }

    .lane:first-child {
      border-top: none;
    }

    .lane:last-child {
      border-bottom: none;
    }

    .controls {
      margin-top: 6px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .btn {
      position: relative;
      padding: 10px 4px;
      border-radius: var(--radius-lg);
      border: none;
      background: linear-gradient(145deg, #1f2937, #111827);
      color: var(--text-main);
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
    }

    .btn span.icon {
      font-size: 1.1rem;
    }

    .btn.primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-soft));
      color: #111827;
      box-shadow: 0 15px 40px rgba(250, 204, 21, 0.5);
    }

    .btn.primary:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 6px 18px rgba(250, 204, 21, 0.45);
    }

    .btn.secondary {
      background: linear-gradient(145deg, #111827, #020617);
      border: 1px solid rgba(148, 163, 184, 0.6);
    }

    .btn.secondary:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.9);
    }

    .btn:focus-visible {
      outline: 2px solid var(--accent-soft);
      outline-offset: 2px;
    }

    .footer-text {
      margin-top: 4px;
      font-size: 0.62rem;
      color: var(--text-muted);
      text-align: center;
      opacity: 0.9;
    }

    .footer-text strong {
      color: var(--accent-soft);
      font-weight: 600;
    }

    /* Overlay cards for intro, level complete, final question, answer */

    .overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      pointer-events: none;
    }

    .overlay-card {
      width: 100%;
      max-width: 330px;
      background: var(--card-bg);
      border-radius: var(--radius-xl);
      border: 1px solid var(--card-border);
      box-shadow: var(--shadow-soft);
      padding: 16px 18px 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      transform: translateY(8px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.16s ease, transform 0.16s ease;
    }

    .overlay-card.visible {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .overlay-tag {
      font-size: 0.64rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--accent-soft);
    }

    .overlay-title {
      font-size: 1.02rem;
      font-weight: 700;
      letter-spacing: 0.03em;
    }

    .overlay-body {
      font-size: 0.78rem;
      color: var(--text-muted);
      line-height: 1.35;
    }

    .overlay-body strong {
      color: var(--accent-soft);
      font-weight: 600;
    }

    .overlay-actions {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .overlay-inline {
      margin-top: 4px;
      font-size: 0.68rem;
      color: var(--text-muted);
    }

    .overlay-inline strong {
      color: var(--good);
    }

    .small-pill {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 0.62rem;
      color: var(--text-muted);
    }

    .small-pill span.value {
      font-weight: 600;
      color: var(--accent-soft);
    }

    @media (max-width: 380px) {
      .app {
        border-radius: 20px;
        padding: 10px;
      }

      .main {
        border-radius: 18px;
      }

      .overlay-card {
        border-radius: 18px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title-block">
        <span class="subtitle">Mini Game Invite</span>
        <h1>Groomsman Trials</h1>
      </div>
      <div class="badge">
        <span class="icon">ü§µ‚Äç‚ôÇÔ∏è</span>
        <span id="hudRoleLabel">Wedding Squad</span>
      </div>
    </header>

    <div class="hud">
      <div class="hud-group">
        <div class="hud-pill">
          <span>Mission</span>
          <span class="value" id="hudMission">Intro</span>
        </div>
        <div class="hud-pill positive">
          <span>Good Catches</span>
          <span class="value" id="hudScore">0</span>
        </div>
      </div>
      <div class="hud-pill negative">
        <span>Chaos Hit</span>
        <span class="value" id="hudBad">0</span>
      </div>
    </div>

    <div class="hint-text">
      Tip: tap <strong>Top lane</strong> or <strong>Bottom lane</strong> to dodge chaos and collect the good stuff.
    </div>

    <main class="main">
      <div class="lane-labels">
        <span>Top lane</span>
        <span>Bottom lane</span>
      </div>

      <div class="canvas-wrapper">
        <canvas id="gameCanvas" width="360" height="420"></canvas>
        <div class="lane-overlay">
          <div class="lane"></div>
          <div class="lane"></div>
        </div>

        <!-- Overlays -->
        <div class="overlay">
          <div id="introCard" class="overlay-card">
            <span class="overlay-tag">Briefing</span>
            <div class="overlay-title" id="introTitle">Welcome, future Groomsman</div>
            <div class="overlay-body" id="introBody">
              Clear a couple of quick missions to prove you can handle wedding squad duties.<br /><br />
              Survive the <strong>Bachelor chaos</strong>, keep the <strong>wedding day</strong> under control, then unlock the real question.
            </div>
            <div class="overlay-actions">
              <button class="btn primary" id="btnStart">
                <span class="icon">‚ñ∂Ô∏è</span>
                <span>Start Trials</span>
              </button>
              <div class="overlay-inline">
                Move between lanes, collect <strong>good icons</strong> like ü•É and üéâ, and avoid chaos like üòµ and üí∏.
              </div>
            </div>
          </div>

          <div id="levelCard" class="overlay-card">
            <span class="overlay-tag">Mission Clear</span>
            <div class="overlay-title" id="levelTitle">Mission 1 complete</div>
            <div class="overlay-body" id="levelBody">
              Nice work. You survived the first test.<br />
              Get ready for the next round.
            </div>
            <div class="overlay-actions">
              <button class="btn primary" id="btnNextMission">
                <span class="icon">üéÆ</span>
                <span>Next Mission</span>
              </button>
              <div class="overlay-inline">
                <span class="small-pill">
                  <span>Good Catches</span>
                  <span class="value" id="levelGoodCount">0</span>
                </span>
              </div>
            </div>
          </div>

          <div id="finalQuestionCard" class="overlay-card">
            <span class="overlay-tag">Final Trial</span>
            <div class="overlay-title" id="finalTitle">You passed all the trials</div>
            <div class="overlay-body" id="finalBody">
              You handled the bachelor chaos, kept the wedding day steady, and proved you have the right energy.<br /><br />
              So here is the real question:
            </div>
            <div class="overlay-actions">
              <button class="btn primary" id="btnYesPrimary">
                <span class="icon">‚úÖ</span>
                <span id="btnYesPrimaryText">Yes, I am in</span>
              </button>
              <button class="btn secondary" id="btnYesSecondary">
                <span class="icon">üî•</span>
                <span id="btnYesSecondaryText">Obviously yes</span>
              </button>
            </div>
          </div>

          <div id="finalAnswerCard" class="overlay-card">
            <span class="overlay-tag">Squad Locked</span>
            <div class="overlay-title" id="finalAnswerTitle">Let us do this</div>
            <div class="overlay-body" id="finalAnswerBody">
              Screenshot this if you want, then send me a message so we can plan the chaos properly.
            </div>
            <div class="overlay-actions">
              <button class="btn primary" id="btnDone">
                <span class="icon">üì≤</span>
                <span>Got it</span>
              </button>
              <div class="overlay-inline">
                You can close this tab and text me whenever you are ready.
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="controls">
        <button class="btn secondary" id="laneTopBtn">
          <span class="icon">‚¨ÜÔ∏è</span>
          <span>Top lane</span>
        </button>
        <button class="btn secondary" id="laneBottomBtn">
          <span class="icon">‚¨áÔ∏è</span>
          <span>Bottom lane</span>
        </button>
      </div>

      <div class="footer-text">
        Designed as a one time invite for the <strong>wedding squad</strong>.
      </div>
    </main>
  </div>

  <script>
    // Utility: get query parameter
    function getQueryParam(key, defaultValue) {
      const params = new URLSearchParams(window.location.search);
      const value = params.get(key);
      if (!value) return defaultValue;
      return decodeURIComponent(value);
    }

    // Personalization
    const guestName = getQueryParam("name", "my friend");
    const guestRoleRaw = getQueryParam("role", "Groomsman");
    const guestRole = guestRoleRaw.toLowerCase();

    const hudRoleLabel = document.getElementById("hudRoleLabel");
    const introTitle = document.getElementById("introTitle");
    const finalTitle = document.getElementById("finalTitle");
    const finalBody = document.getElementById("finalBody");
    const btnYesPrimaryText = document.getElementById("btnYesPrimaryText");
    const btnYesSecondaryText = document.getElementById("btnYesSecondaryText");
    const finalAnswerTitle = document.getElementById("finalAnswerTitle");
    const finalAnswerBody = document.getElementById("finalAnswerBody");

    function setupPersonalization() {
      let displayRole;
      let askLine;
      let primaryText;
      let secondaryText;
      let finalLine;

      if (guestRole.includes("best")) {
        displayRole = "Best Man Invite";
        askLine = `Will you be one of my Best Men, ${guestName}?`;
        primaryText = "Yes, I will be your Best Man";
        secondaryText = "Obviously yes";
        finalLine = `${guestName}, you are locked in as Best Man. Thank you for being in this with me.`;
      } else {
        displayRole = "Groomsman Invite";
        askLine = `Will you be my Groomsman, ${guestName}?`;
        primaryText = "Yes, I will be your Groomsman";
        secondaryText = "Hell yes, I am in";
        finalLine = `${guestName}, you are officially part of the groomsman squad. Let us make it legendary.`;
      }

      hudRoleLabel.textContent = displayRole;
      introTitle.textContent = `Welcome, ${guestName}`;
      finalTitle.textContent = `You passed all the trials, ${guestName}`;
      finalBody.innerHTML =
        "You handled the bachelor chaos, kept the wedding day steady, and proved you have the right energy.<br /><br />" +
        `<strong>${askLine}</strong>`;
      btnYesPrimaryText.textContent = primaryText;
      btnYesSecondaryText.textContent = secondaryText;
      finalAnswerTitle.textContent = "Squad locked in";
      finalAnswerBody.textContent =
        finalLine +
        " Screenshot this if you want, then send me a message so we can plan the chaos properly.";
    }

    // Game logic
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    const hudMission = document.getElementById("hudMission");
    const hudScore = document.getElementById("hudScore");
    const hudBad = document.getElementById("hudBad");
    const levelTitle = document.getElementById("levelTitle");
    const levelBody = document.getElementById("levelBody");
    const levelGoodCount = document.getElementById("levelGoodCount");

    const introCard = document.getElementById("introCard");
    const levelCard = document.getElementById("levelCard");
    const finalQuestionCard = document.getElementById("finalQuestionCard");
    const finalAnswerCard = document.getElementById("finalAnswerCard");

    const btnStart = document.getElementById("btnStart");
    const btnNextMission = document.getElementById("btnNextMission");
    const btnYesPrimary = document.getElementById("btnYesPrimary");
    const btnYesSecondary = document.getElementById("btnYesSecondary");
    const btnDone = document.getElementById("btnDone");
    const laneTopBtn = document.getElementById("laneTopBtn");
    const laneBottomBtn = document.getElementById("laneBottomBtn");

    const missions = [
      {
        name: "Bachelor Mission",
        description: "Collect 5 good icons and keep the chaos under control.",
        targetGood: 5
      },
      {
        name: "Wedding Day Mission",
        description: "Collect 8 good icons while dodging hangovers and drama.",
        targetGood: 8
      }
    ];

    let state = "intro"; // intro, playing, betweenLevels, finalQuestion, finalAnswer
    let currentMissionIndex = 0;
    let goodCaught = 0;
    let badHit = 0;

    const player = {
      lane: 0, // 0 top, 1 bottom
      x: 80,
      radius: 16
    };

    const lanesY = [canvas.height * 0.32, canvas.height * 0.7];

    const items = [];
    let lastSpawnTime = 0;
    let spawnInterval = 700; // ms
    let lastFrameTime = performance.now();

    const goodIcons = ["ü•É", "üéâ", "ü§µ‚Äç‚ôÇÔ∏è", "üçï"];
    const badIcons = ["üòµ", "‚è∞", "üí∏"];

    function resetMission(index) {
      currentMissionIndex = index;
      goodCaught = 0;
      badHit = 0;
      items.length = 0;
      lastSpawnTime = 0;
      hudMission.textContent = missions[currentMissionIndex].name;
      hudScore.textContent = "0";
      hudBad.textContent = "0";
      player.lane = 0;
    }

    function showCard(card) {
      [introCard, levelCard, finalQuestionCard, finalAnswerCard].forEach(c => {
        c.classList.remove("visible");
      });
      if (card) {
        card.classList.add("visible");
      }
    }

    function startGame() {
      state = "playing";
      resetMission(0);
      showCard(null);
    }

    function goToNextMission() {
      if (currentMissionIndex + 1 < missions.length) {
        resetMission(currentMissionIndex + 1);
        state = "playing";
        showCard(null);
      } else {
        state = "finalQuestion";
        showCard(finalQuestionCard);
      }
    }

    function handleMissionComplete() {
      state = "betweenLevels";
      levelTitle.textContent = missions[currentMissionIndex].name + " complete";
      levelBody.textContent = missions[currentMissionIndex].description.replace(
        "Collect",
        "You collected"
      );
      levelGoodCount.textContent = String(goodCaught);
      showCard(levelCard);
    }

    function handleYesAnswer() {
      state = "finalAnswer";
      showCard(finalAnswerCard);
    }

    function update(dt) {
      if (state !== "playing") return;

      // Spawn items
      const now = performance.now();
      if (now - lastSpawnTime > spawnInterval) {
        lastSpawnTime = now;
        const lane = Math.random() < 0.5 ? 0 : 1;
        const isGood = Math.random() < 0.7; // 70 percent chance good
        const iconList = isGood ? goodIcons : badIcons;
        const icon = iconList[Math.floor(Math.random() * iconList.length)];

        items.push({
          lane,
          x: canvas.width + 40,
          y: lanesY[lane],
          radius: 14,
          icon,
          good: isGood
        });
      }

      // Move items
      const speed = 190; // px per second
      for (let i = items.length - 1; i >= 0; i--) {
        items[i].x -= speed * (dt / 1000);

        // Collision with player
        const dx = items[i].x - player.x;
        const dy = items[i].y - lanesY[player.lane];
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < player.radius + items[i].radius) {
          if (items[i].good) {
            goodCaught++;
            hudScore.textContent = String(goodCaught);
          } else {
            badHit++;
            hudBad.textContent = String(badHit);
          }
          items.splice(i, 1);
          continue;
        }

        // Remove off screen
        if (items[i].x < -60) {
          items.splice(i, 1);
        }
      }

      const targetGood = missions[currentMissionIndex].targetGood;
      if (goodCaught >= targetGood) {
        handleMissionComplete();
      }
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Background gradient
      const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
      gradient.addColorStop(0, "#020617");
      gradient.addColorStop(1, "#020617");
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Lane highlights
      for (let i = 0; i < 2; i++) {
        const y = lanesY[i];
        ctx.save();
        ctx.strokeStyle = "rgba(51,65,85,0.8)";
        ctx.lineWidth = 1;
        ctx.setLineDash([6, 6]);
        ctx.beginPath();
        ctx.moveTo(18, y);
        ctx.lineTo(canvas.width - 18, y);
        ctx.stroke();
        ctx.restore();
      }

      // Player
      const px = player.x;
      const py = lanesY[player.lane];

      ctx.save();
      const playerGradient = ctx.createRadialGradient(
        px - 4,
        py - 6,
        4,
        px,
        py,
        26
      );
      playerGradient.addColorStop(0, "#facc15");
      playerGradient.addColorStop(1, "#f97316");
      ctx.fillStyle = playerGradient;
      ctx.beginPath();
      ctx.arc(px, py, player.radius + 2, 0, Math.PI * 2);
      ctx.fill();

      ctx.fillStyle = "#111827";
      ctx.beginPath();
      ctx.arc(px, py, player.radius - 2, 0, Math.PI * 2);
      ctx.fill();

      ctx.font = "18px system-ui";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillStyle = "#f9fafb";
      ctx.fillText("üòé", px, py + 1);
      ctx.restore();

      // Items
      items.forEach(item => {
        ctx.save();
        ctx.font = "20px system-ui";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(item.icon, item.x, item.y);
        ctx.restore();
      });
    }

    function gameLoop(timestamp) {
      const dt = timestamp - lastFrameTime;
      lastFrameTime = timestamp;

      update(dt);
      draw();

      requestAnimationFrame(gameLoop);
    }

    // Input
    laneTopBtn.addEventListener("click", () => {
      player.lane = 0;
    });

    laneBottomBtn.addEventListener("click", () => {
      player.lane = 1;
    });

    // Keyboard support for testing on desktop
    window.addEventListener("keydown", e => {
      if (e.key === "ArrowUp" || e.key === "w") {
        player.lane = 0;
      } else if (e.key === "ArrowDown" || e.key === "s") {
        player.lane = 1;
      }
    });

    // Buttons for overlay cards
    btnStart.addEventListener("click", startGame);
    btnNextMission.addEventListener("click", goToNextMission);
    btnYesPrimary.addEventListener("click", handleYesAnswer);
    btnYesSecondary.addEventListener("click", handleYesAnswer);
    btnDone.addEventListener("click", () => {
      // Simple close action, no navigation required
      finalAnswerCard.classList.remove("visible");
    });

    // Initialize
    setupPersonalization();
    showCard(introCard);
    hudMission.textContent = "Briefing";

    lastFrameTime = performance.now();
    requestAnimationFrame(gameLoop);
  </script>
</body>
</html>
